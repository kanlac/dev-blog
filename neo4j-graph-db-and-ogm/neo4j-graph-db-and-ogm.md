# Neo4j 图数据库与 Java 对象映射

## Graph DB v.s. Relational DB

传统的关系型数据库（Relational Database）存储的形式是表格，不论是数据的属性还是实体间的关系，都是一行行地存在固定的表格中的，这样不仅要花时间构建符合需求的数据模型，如果需要对实体属性作出调整也是非常麻烦。

在图数据库中，这些弊端就不复存在了，因为它直接利用我们构造模型草图时会用的结点-关系连接来作为数据的存储结构，不用再去处理主外键的问题。

## 学习图数据库

Neo4j 是主流的图数据库，除了详尽的教程和文档支持外，[官网](neo4j.com)还提供了不少教学资源。Cypher 是 Neo4j 使用的数据库查询语言，而且比 SQL 更加易学好用。

## Introducing OGM

Neo4j 还有一个很优越的地方在于，它提供了完整的对象映射的支持，通过一个工具库就可以把全部或者部分的数据映射到任意一种 Java 集合类型（`Iterable` 接口）进行处理。

Neo4j 对 OGM 是这样解释的：

> An OGM (Object Graph Mapper) maps nodes and relationships in the graph to objects and references in a domain model. Object instances are mapped to nodes while object references are mapped using relationships, or serialized to properties (e.g. references to a Date). JVM primitives are mapped to node or relationship properties. An OGM abstracts the database and provides a convenient way to persist your domain model in the graph and query it without using low level drivers. It also provides the flexibility to the developer to supply custom queries where the queries generated by the OGM are insufficient.

试转译：

> OGM (Object Graph Mapper) 是一种匹配器，它将图中的 nodes 和 relationships 匹配到域模型中的一个个对象。OGM 把数据库抽象出来，提供一个方便的方式去交互处理图中的对象，并能在不使用底层的数据库连接驱动的情况下进行查询。当 OGM 生成的查询不能满足需要的时候，它也具有添加自定义查询的灵活性。

Neo4j-OGM 是一个 Java 库，使用它能通过标注了的域模型（POJO 类）建立与数据库的匹配。在 OGM 的支持下，连接数据库进行更新的次数得到了最小化。

对数据库的操作简化为了对 Java 对象的操作，提交更改的过程则隐藏到了 session 之后。

而至于 session 是什么，文档中又是这样说的：

> The Session keeps track of changes made to entities and relationships and persists ones that have been modified on save. Once an entity is tracked by the session, reloading this entity within the scope of the same session will result in the session cache returning the previously loaded entity. However, the subgraph in the session will expand if the entity or its related entities retrieve additional relationships from the graph.

转译如下：

> 一个 session 中存有实体和关系的变更信息，一旦一个实体被一个 session 追踪了，如果在同一个 session 的作用域中重复加载该实体，将直接从 session 缓存的这部分子图中获得。如果数据库中的图的相关实体有新增加的关系，session 子图则会扩增。

如果想要从数据库获取最新的数据，可以创建一个新的 session，或者用 Session.clear() 清空。Session 的生命周期可以通过编写代码来控制，太长或者太短都不好。

## 应用 OGM 的步骤
1. 在构建工具（Maven 或 Graddle）中添加 ogm 依赖；
2. 连接到数据库；
3. 构建域模型，这是匹配数据库对象到 Java 对象的关键；
4. 实现一个单例模式，提供创建 session 的接口；
5. 使用 Service 结构，定义与数据库交互的接口，以及实现类。

*更多参考 Neo4j 的官方文档：https://neo4j.com/docs/ogm-manual/current/introduction/*